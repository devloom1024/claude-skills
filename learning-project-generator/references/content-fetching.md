# 内容获取与保存指南

当用户提供 URL 时，需要获取内容并保存到生成的学习项目中，以便后续学习时引用。

## 工作流程

### 1. 检测 firecrawl MCP 可用性

优先使用 firecrawl MCP（如果可用），因为它提供更可靠的内容抓取和更好的格式化。

**检测方法**：尝试使用 firecrawl 工具，如果失败则降级到 WebFetch。

### 2. 获取主页面内容

#### 2.1 使用 firecrawl（首选）

```javascript
mcp__mcp-server-firecrawl__firecrawl_scrape({
  url: "用户提供的URL",
  formats: ["markdown"],
  onlyMainContent: true
})
```

**优势**：
- 自动转换为 markdown 格式
- 提取主要内容，过滤广告和导航
- 更可靠的内容抓取

#### 2.2 使用 WebFetch（降级方案）

```javascript
WebFetch({
  url: "用户提供的URL",
  prompt: "请提取这个页面的完整内容，包括所有章节、标题、正文和链接。保持原有的结构层次。"
})
```

### 3. 分析内容结构

分析获取的内容，识别：
- **章节目录**：课程大纲、书籍目录、学习路径
- **相关链接**：子页面、练习题、参考资料
- **内容类型**：教程、文档、课程、书籍章节

### 4. 递归获取关联内容

**重要**：如果页面包含多个章节/课程链接，应该递归获取所有相关内容。

#### 4.1 识别需要获取的链接

从主页面中提取：
- 章节链接（如：第1章、第2章...）
- 课程模块链接
- 练习题链接
- 重要参考资料链接

**判断标准**：
- 链接是否属于学习路径的一部分
- 链接是否包含核心学习内容
- 避免抓取外部网站或不相关的链接

#### 4.2 批量获取内容

对于多个链接，使用并行方式提高效率：

**使用 firecrawl（推荐）**：
```javascript
// 对每个链接并行调用
Promise.all([
  firecrawl_scrape({ url: link1, formats: ["markdown"], onlyMainContent: true }),
  firecrawl_scrape({ url: link2, formats: ["markdown"], onlyMainContent: true }),
  // ... 更多链接
])
```

**注意**：
- 限制并行数量（建议 5-10 个）避免超时
- 对于大量链接，分批处理

#### 4.3 处理获取失败

**重要**：记录所有无法获取的链接，并在保存的文件中说明。

对于每个失败的链接，记录：
- URL 地址
- 失败原因（超时、404、拒绝访问等）
- 建议用户手动补充

### 5. 保存内容到项目

#### 5.1 目录结构

```
{project-name}/materials/
├── README.md              # 材料索引和说明
├── main.md                # 主页面内容
├── chapter-01.md          # 第1章内容
├── chapter-02.md          # 第2章内容
├── failed-links.md        # 无法获取的链接列表（如果有）
└── images/                # 图片资源（如果需要）
```

#### 5.2 文件命名规范

- **主页面**：`main.md` 或根据内容类型命名（如 `index.md`、`overview.md`）
- **章节页面**：`chapter-01.md`、`chapter-02.md` 或使用有意义的名称（如 `arrays-tutorial.md`、`sorting-algorithms.md`）
- **元数据文件**：`README.md`（材料索引）、`failed-links.md`（失败链接列表）

#### 5.3 文件格式

每个保存的 markdown 文件应包含：

```markdown
---
source_url: https://example.com/page
fetch_date: 2025-01-08
title: 页面标题
---

# 页面标题

[内容正文...]

---

**来源**：[原始页面](https://example.com/page)
**抓取时间**：2025-01-08
```

#### 5.4 创建 README.md

在 `/materials/` 目录下创建 `README.md` 索引文件：

```markdown
# 学习材料

本目录包含从以下来源获取的学习材料：

## 主要内容

- [main.md](main.md) - 课程主页/概览
  - 来源：https://example.com
  - 抓取时间：2025-01-08

## 章节内容

- [chapter-01.md](chapter-01.md) - 第1章：数组基础
- [chapter-02.md](chapter-02.md) - 第2章：排序算法
- [chapter-03.md](chapter-03.md) - 第3章：搜索算法

## 获取状态

✅ 成功获取：15 个页面
⚠️ 部分失败：3 个页面（详见 [failed-links.md](failed-links.md)）

## 使用说明

这些材料是学习的参考资源。在学习过程中：
1. Claude 会在需要时自动引用这些材料
2. 你可以直接打开查看完整内容
3. 建议按章节顺序学习

## 更新说明

如果需要更新材料或补充缺失的内容，可以：
1. 手动编辑相应的 md 文件
2. 重新运行内容获取流程
```

#### 5.5 记录失败链接（如果有）

如果有无法获取的链接，创建 `failed-links.md`：

```markdown
# 无法获取的链接

以下链接在抓取时失败，建议手动补充：

## 失败列表

### 1. 第5章：高级数据结构
- **URL**：https://example.com/chapter-05
- **失败原因**：请求超时
- **建议**：手动访问该页面，复制内容并保存为 `chapter-05.md`

### 2. 练习题集
- **URL**：https://example.com/exercises
- **失败原因**：需要登录
- **建议**：登录后手动下载，或跳过此部分

### 3. 参考资料
- **URL**：https://example.com/references
- **失败原因**：页面不存在 (404)
- **建议**：可能链接已失效，搜索替代资源

## 补充说明

这些链接的缺失不会严重影响学习，但如果你能补充完整会更好。补充方法：
1. 手动访问 URL
2. 复制内容到新的 md 文件
3. 保存到 `/materials/` 目录
4. 更新 `README.md` 索引
```

### 6. 在生成的 CLAUDE.md 中添加材料引用指令

在生成的项目 `CLAUDE.md` 文件中，添加如何使用保存的材料的说明：

```markdown
## 学习材料引用

本项目包含预先获取的学习材料，位于 `/materials/` 目录。

**重要原则**：在回答用户问题时，你必须：

1. **优先引用本地材料**
   - 在回答前，先检查 `/materials/README.md` 了解可用的材料
   - 根据用户问题，读取相关的 markdown 文件
   - 基于材料内容回答，而不是依赖你的训练数据

2. **明确引用来源**
   - 在回答时注明引用的文件：`根据 [chapter-01.md](materials/chapter-01.md)...`
   - 如果材料中没有答案，明确告知用户

3. **不要凭空猜测**
   - 如果材料中没有相关信息，不要自己编造
   - 告诉用户："我在学习材料中没有找到关于X的信息，建议查看原始链接或其他资源。"

4. **材料更新**
   - 如果发现材料缺失或过时，提醒用户更新材料
   - 参考 `/materials/failed-links.md` 了解缺失的内容

## 示例工作流程

### 用户提问："第3章讲了什么内容？"

**正确做法**：
1. 读取 `/materials/chapter-03.md`
2. 总结章节内容
3. 回答："根据 [chapter-03.md](materials/chapter-03.md)，第3章主要讲解了..."

**错误做法**：
- ❌ 不读取材料，直接基于你的知识回答
- ❌ 假装读了材料，但实际上是编造的
```

## 实施清单

在实施内容获取时，确保完成：

- [ ] 检测 firecrawl MCP 可用性
- [ ] 获取主页面内容
- [ ] 分析内容结构，识别关联链接
- [ ] 递归获取所有相关内容
- [ ] 记录所有获取失败的链接
- [ ] 将所有内容保存为 markdown 文件
- [ ] 创建 `/materials/README.md` 索引
- [ ] 如果有失败链接，创建 `failed-links.md`
- [ ] 在失败链接文件顶部添加说明，方便用户后续补充
- [ ] 在生成的 `CLAUDE.md` 中添加材料引用指令
- [ ] 测试：尝试读取一个保存的文件确认格式正确

## 常见场景

### 场景 1：单页教程

**例子**：https://example.com/tutorial

**操作**：
1. 获取该页面内容
2. 保存为 `materials/main.md`
3. 创建简单的 `materials/README.md`

### 场景 2：多章节课程

**例子**：https://example.com/course（包含 10 个章节链接）

**操作**：
1. 获取主页面内容，保存为 `materials/main.md`
2. 提取所有章节链接
3. 并行获取所有章节（分批处理）
4. 保存为 `materials/chapter-01.md` 到 `materials/chapter-10.md`
5. 创建详细的 `materials/README.md` 索引

### 场景 3：部分链接失败

**例子**：10 个链接中有 2 个获取失败

**操作**：
1. 保存成功获取的 8 个文件
2. 创建 `materials/failed-links.md` 记录失败的 2 个链接
3. 在失败链接文件中说明：
   - 哪些链接失败
   - 失败原因
   - 建议用户如何补充
4. 在 `materials/README.md` 中注明部分内容缺失

### 场景 4：内容需要登录

**例子**：页面返回"需要登录"

**操作**：
1. 记录到 `failed-links.md`
2. 说明失败原因："需要登录访问"
3. 建议用户："请手动登录后复制内容，或使用其他公开资源"

## 性能优化

### 批量获取策略

对于大量链接（>20 个）：
1. 先获取前 5-10 个链接测试
2. 如果成功率高，继续批量获取
3. 如果失败率高，考虑降低并行数或切换策略

### 超时处理

- 单个页面超时：跳过并记录到 failed-links.md
- 批量超时：减少并行数量重试

### 内容过滤

获取内容时，过滤掉：
- 网站导航栏
- 广告内容
- 评论区
- 页脚信息

使用 firecrawl 的 `onlyMainContent: true` 参数可以自动处理。
